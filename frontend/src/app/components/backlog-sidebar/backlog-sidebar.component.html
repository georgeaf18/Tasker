<div class="backlog-sidebar-container">
    <div class="accordion-wrapper">
        <p-accordion
            [multiple]="true"
            [(value)]="expandedPanels"
            class="workspace-accordion">

            <!-- Work Section -->
            <p-accordionpanel [value]="0">
                <p-accordionheader>
                    <div class="workspace-header work-header">
                        <i class="pi pi-briefcase workspace-icon"></i>
                        <span class="workspace-name">Work</span>
                        <p-badge [value]="workTaskCount().toString()" styleClass="workspace-badge" />
                    </div>
                </p-accordionheader>
                <p-accordioncontent>
                <div
                    class="workspace-content"
                    cdkDropList
                    [cdkDropListData]="workTasks()"
                    [cdkDropListConnectedTo]="['today-list', 'in-progress-list', 'done-list', 'personal-backlog-list']"
                    (cdkDropListDropped)="onDrop($event)"
                    id="work-backlog-list">
                    @if (workTasks().length === 0) {
                        <p-message severity="info" [text]="'No work tasks in backlog'" />
                    } @else {
                        @for (task of workTasks(); track task.id) {
                            <div class="task-list-item">
                                <p-card
                                    cdkDrag
                                    [cdkDragData]="task"
                                    [style]="{'cursor': 'grab'}"
                                    (click)="showTaskDetails(task)"
                                    [pTooltip]="task.description || 'No description'"
                                    tooltipPosition="right"
                                >
                                    <div class="task-card-content">
                                        <div class="task-title">{{ task.title }}</div>
                                        @if (task.dueDate) {
                                            <div class="task-meta">
                                                <i class="pi pi-calendar"></i>
                                                <span>{{ task.dueDate | date:'short' }}</span>
                                            </div>
                                        }
                                        @if (task.isRoutine) {
                                            <div class="task-routine-badge">
                                                <i class="pi pi-sync"></i> Routine
                                            </div>
                                        }
                                    </div>
                                </p-card>
                            </div>
                        }
                    }
                </div>
                </p-accordioncontent>
            </p-accordionpanel>

            <!-- Personal Section -->
            <p-accordionpanel [value]="1">
                <p-accordionheader>
                    <div class="workspace-header personal-header">
                        <i class="pi pi-home workspace-icon"></i>
                        <span class="workspace-name">Personal</span>
                        <p-badge [value]="personalTaskCount().toString()" styleClass="workspace-badge" />
                    </div>
                </p-accordionheader>
                <p-accordioncontent>
                <div
                    class="workspace-content"
                    cdkDropList
                    [cdkDropListData]="personalTasks()"
                    [cdkDropListConnectedTo]="['today-list', 'in-progress-list', 'done-list', 'work-backlog-list']"
                    (cdkDropListDropped)="onDrop($event)"
                    id="personal-backlog-list">
                    @if (personalTasks().length === 0) {
                        <p-message severity="info" [text]="'No personal tasks in backlog'" />
                    } @else {
                        @for (task of personalTasks(); track task.id) {
                            <div class="task-list-item">
                                <p-card
                                    cdkDrag
                                    [cdkDragData]="task"
                                    [style]="{'cursor': 'grab'}"
                                    (click)="showTaskDetails(task)"
                                    [pTooltip]="task.description || 'No description'"
                                    tooltipPosition="right"
                                >
                                    <div class="task-card-content">
                                        <div class="task-title">{{ task.title }}</div>
                                        @if (task.dueDate) {
                                            <div class="task-meta">
                                                <i class="pi pi-calendar"></i>
                                                <span>{{ task.dueDate | date:'short' }}</span>
                                            </div>
                                        }
                                        @if (task.isRoutine) {
                                            <div class="task-routine-badge">
                                                <i class="pi pi-sync"></i> Routine
                                            </div>
                                        }
                                    </div>
                                </p-card>
                            </div>
                        }
                    }
                </div>
                </p-accordioncontent>
            </p-accordionpanel>
        </p-accordion>
    </div>

    <!-- Floating Action Button -->
    <div class="fab-container">
        <p-button
            icon="pi pi-plus"
            [rounded]="true"
            [raised]="true"
            severity="primary"
            (onClick)="showCreateTaskDialog()"
            pTooltip="Create New Task"
            tooltipPosition="left"
        />
    </div>
</div>

<!-- Create Task Dialog -->
<p-dialog 
    [(visible)]="createTaskDialogVisible" 
    [header]="'Create New Task'" 
    [modal]="true"
    [style]="{width: '450px'}"
    [draggable]="false"
    [resizable]="false"
>
    <form [formGroup]="createTaskForm" (ngSubmit)="submitCreateTask()">
        <div class="form-field">
            <label for="title">Title *</label>
            <input
                id="title"
                type="text"
                pInputText
                formControlName="title"
                placeholder="Enter task title"
                class="w-full"
            />
            @if (createTaskForm.get('title')?.invalid && createTaskForm.get('title')?.touched) {
                <small class="error-message">Title is required</small>
            }
        </div>

        <div class="form-field">
            <label for="description">Description</label>
            <textarea
                id="description"
                pTextarea
                formControlName="description"
                placeholder="Enter task description"
                [rows]="3"
                class="w-full"
            ></textarea>
        </div>

        <div class="form-field">
            <label for="status">Add to *</label>
            <p-select
                id="status"
                formControlName="status"
                [options]="statusOptions"
                optionLabel="label"
                optionValue="value"
                placeholder="Select column"
                class="w-full"
            />
        </div>

        <div class="form-field">
            <label for="workspace">Context *</label>
            <p-select
                id="workspace"
                formControlName="workspace"
                [options]="workspaceOptions"
                optionLabel="label"
                optionValue="value"
                placeholder="Select context"
                class="w-full"
            />
        </div>
        
        <div class="form-field">
            <label for="channel">Channel</label>
            <p-select
                id="channel"
                formControlName="channelId"
                [options]="filteredChannels()"
                optionLabel="name"
                optionValue="id"
                placeholder="Select channel (optional)"
                class="w-full"
                [showClear]="true"
            />
        </div>
        
        <div class="form-field">
            <label for="dueDate">Due Date</label>
            <p-datepicker
                id="dueDate"
                formControlName="dueDate"
                [showIcon]="true"
                placeholder="Select due date (optional)"
                class="w-full"
                dateFormat="mm/dd/yy"
                [showTime]="true"
            />
        </div>
        
        <div class="form-field-checkbox">
            <p-checkbox 
                formControlName="isRoutine"
                [binary]="true"
                inputId="isRoutine"
            />
            <label for="isRoutine">Is this a routine task?</label>
        </div>
    </form>
    
    <ng-template pTemplate="footer">
        <p-button 
            label="Cancel" 
            severity="secondary"
            (onClick)="hideCreateTaskDialog()"
        />
        <p-button 
            label="Create" 
            severity="primary"
            (onClick)="submitCreateTask()"
            [disabled]="createTaskForm.invalid"
        />
    </ng-template>
</p-dialog>

<!-- Task Details/Edit Dialog -->
<p-dialog 
    [(visible)]="taskDetailsDialogVisible" 
    [header]="'Task Details'" 
    [modal]="true"
    [style]="{width: '450px'}"
    [draggable]="false"
    [resizable]="false"
>
    @if (selectedTask()) {
        <form [formGroup]="editTaskForm" (ngSubmit)="submitEditTask()">
            <div class="form-field">
                <label for="edit-title">Title *</label>
                <input 
                    id="edit-title"
                    type="text" 
                    pInputText 
                    formControlName="title"
                    placeholder="Enter task title"
                    class="w-full"
                />
                @if (editTaskForm.get('title')?.invalid && editTaskForm.get('title')?.touched) {
                    <small class="error-message">Title is required</small>
                }
            </div>
            
            <div class="form-field">
                <label for="edit-description">Description</label>
                <textarea 
                    id="edit-description"
                    pTextarea
                    formControlName="description"
                    placeholder="Enter task description"
                    [rows]="3"
                    class="w-full"
                ></textarea>
            </div>
            
            <div class="form-field">
                <label for="edit-workspace">Context *</label>
                <p-select
                    id="edit-workspace"
                    formControlName="workspace"
                    [options]="workspaceOptions"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="Select context"
                    class="w-full"
                />
            </div>
            
            <div class="form-field">
                <label for="edit-channel">Channel</label>
                <p-select
                    id="edit-channel"
                    formControlName="channelId"
                    [options]="filteredChannels()"
                    optionLabel="name"
                    optionValue="id"
                    placeholder="Select channel (optional)"
                    class="w-full"
                    [showClear]="true"
                />
            </div>
            
            <div class="form-field">
                <label for="edit-dueDate">Due Date</label>
                <p-datepicker
                    id="edit-dueDate"
                    formControlName="dueDate"
                    [showIcon]="true"
                    placeholder="Select due date (optional)"
                    class="w-full"
                    dateFormat="mm/dd/yy"
                    [showTime]="true"
                />
            </div>
            
            <div class="form-field-checkbox">
                <p-checkbox 
                    formControlName="isRoutine"
                    [binary]="true"
                    inputId="edit-isRoutine"
                />
                <label for="edit-isRoutine">Is this a routine task?</label>
            </div>
        </form>
    }
    
    <ng-template pTemplate="footer">
        <p-button 
            label="Delete" 
            severity="danger"
            icon="pi pi-trash"
            (onClick)="confirmDeleteTask()"
        />
        <p-button 
            label="Cancel" 
            severity="secondary"
            (onClick)="hideTaskDetailsDialog()"
        />
        <p-button 
            label="Save" 
            severity="primary"
            (onClick)="submitEditTask()"
            [disabled]="editTaskForm.invalid"
        />
    </ng-template>
</p-dialog>

<!-- Confirmation Dialog -->
<p-confirmDialog />
