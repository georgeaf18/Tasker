<div class="kanban-container">
  <!-- Progress Bar at Top -->
  <div class="progress-section">
    <div class="progress-header">
      <h2>Daily Progress</h2>
      <span class="progress-percentage">{{ dailyProgress() }}%</span>
    </div>
    <p-progressBar
      [value]="dailyProgress()"
      [showValue]="false"
      styleClass="custom-progress-bar">
    </p-progressBar>
  </div>

  <!-- Board Controls -->
  <div class="board-controls">
    <p-button
      [icon]="currentLayout() === BoardLayout.TRADITIONAL ? 'pi pi-crosshair' : 'pi pi-th-large'"
      [label]="currentLayout() === BoardLayout.TRADITIONAL ? 'Focus Mode' : 'Traditional View'"
      (onClick)="toggleBoardLayout()"
      severity="secondary"
      [text]="true"
      size="small">
    </p-button>
  </div>

  <!-- Traditional 3-Column Layout -->
  @if (currentLayout() === BoardLayout.TRADITIONAL) {
  <div class="kanban-board">
    
    <!-- TODAY Column -->
    <div class="kanban-column today-column">
      <p-panel styleClass="kanban-panel">
        <ng-template pTemplate="header">
          <div class="column-header">
            <div class="column-title">
              <i class="pi pi-calendar"></i>
              <span>Today</span>
            </div>
            <p-badge
              [value]="todayTasks().length.toString()"
              severity="info">
            </p-badge>
          </div>
        </ng-template>

        <div
          class="column-content"
          cdkDropList
          [cdkDropListData]="todayTasks()"
          [cdkDropListConnectedTo]="['work-backlog-list', 'personal-backlog-list', 'in-progress-list', 'done-list']"
          (cdkDropListDropped)="onDrop($event, TaskStatus.TODAY)"
          id="today-list">
          @if (todayTasks().length === 0) {
            <p-message
              severity="info"
              text="No tasks scheduled for today"
              styleClass="empty-message">
            </p-message>
          } @else {
            @for (task of todayTasks(); track task.id) {
              <p-card
                styleClass="task-card"
                cdkDrag
                [cdkDragData]="task"
                (click)="openTaskDetails(task)">
                <ng-template pTemplate="header">
                  <div class="task-card-header">
                    @if (task.channel) {
                      <p-chip 
                        [label]="task.channel.name"
                        styleClass="channel-chip">
                      </p-chip>
                    }
                    @if (task.isRoutine) {
                      <i class="pi pi-refresh routine-icon" 
                         pTooltip="Routine Task"
                         tooltipPosition="top">
                      </i>
                    }
                  </div>
                </ng-template>

                <div class="task-card-body">
                  <h3 class="task-title">{{ task.title }}</h3>

                  @if (task.taskTags && task.taskTags.length > 0) {
                    <div class="task-tags">
                      @for (taskTag of task.taskTags; track taskTag.tag.id) {
                        <span
                          class="task-tag-chip"
                          [style.background-color]="taskTag.tag.color">
                          {{ taskTag.tag.name }}
                        </span>
                      }
                    </div>
                  }

                  <div class="task-meta">
                    <p-tag
                      [value]="task.workspace"
                      [severity]="getWorkspaceSeverity(task.workspace)"
                      styleClass="workspace-tag">
                    </p-tag>

                    @if (task.dueDate) {
                      <span class="due-date">
                        <i class="pi pi-calendar"></i>
                        {{ formatDate(task.dueDate) }}
                      </span>
                    }
                  </div>
                </div>
              </p-card>
            }
          }
        </div>
      </p-panel>
    </div>

    <!-- IN PROGRESS Column -->
    <div class="kanban-column in-progress-column">
      <p-panel styleClass="kanban-panel">
        <ng-template pTemplate="header">
          <div class="column-header">
            <div class="column-title">
              <i class="pi pi-spinner"></i>
              <span>In Progress</span>
            </div>
            <p-badge
              [value]="inProgressTasks().length.toString()"
              severity="warn">
            </p-badge>
          </div>
        </ng-template>

        <div
          class="column-content"
          cdkDropList
          [cdkDropListData]="inProgressTasks()"
          [cdkDropListConnectedTo]="['work-backlog-list', 'personal-backlog-list', 'today-list', 'done-list']"
          (cdkDropListDropped)="onDrop($event, TaskStatus.IN_PROGRESS)"
          id="in-progress-list">
          @if (inProgressTasks().length === 0) {
            <p-message
              severity="info"
              text="No tasks in progress"
              styleClass="empty-message">
            </p-message>
          } @else {
            @for (task of inProgressTasks(); track task.id) {
              <p-card
                styleClass="task-card"
                cdkDrag
                [cdkDragData]="task"
                (click)="openTaskDetails(task)">
                <ng-template pTemplate="header">
                  <div class="task-card-header">
                    @if (task.channel) {
                      <p-chip 
                        [label]="task.channel.name"
                        styleClass="channel-chip">
                      </p-chip>
                    }
                    @if (task.isRoutine) {
                      <i class="pi pi-refresh routine-icon" 
                         pTooltip="Routine Task"
                         tooltipPosition="top">
                      </i>
                    }
                  </div>
                </ng-template>

                <div class="task-card-body">
                  <h3 class="task-title">{{ task.title }}</h3>

                  @if (task.taskTags && task.taskTags.length > 0) {
                    <div class="task-tags">
                      @for (taskTag of task.taskTags; track taskTag.tag.id) {
                        <span
                          class="task-tag-chip"
                          [style.background-color]="taskTag.tag.color">
                          {{ taskTag.tag.name }}
                        </span>
                      }
                    </div>
                  }

                  <div class="task-meta">
                    <p-tag
                      [value]="task.workspace"
                      [severity]="getWorkspaceSeverity(task.workspace)"
                      styleClass="workspace-tag">
                    </p-tag>

                    @if (task.dueDate) {
                      <span class="due-date">
                        <i class="pi pi-calendar"></i>
                        {{ formatDate(task.dueDate) }}
                      </span>
                    }
                  </div>
                </div>
              </p-card>
            }
          }
        </div>
      </p-panel>
    </div>

    <!-- DONE Column -->
    <div class="kanban-column done-column">
      <p-panel styleClass="kanban-panel">
        <ng-template pTemplate="header">
          <div class="column-header">
            <div class="column-title">
              <i class="pi pi-check-circle"></i>
              <span>Done</span>
            </div>
            <p-badge
              [value]="doneTasks().length.toString()"
              severity="success">
            </p-badge>
          </div>
        </ng-template>

        <div
          class="column-content"
          cdkDropList
          [cdkDropListData]="doneTasks()"
          [cdkDropListConnectedTo]="['work-backlog-list', 'personal-backlog-list', 'today-list', 'in-progress-list']"
          (cdkDropListDropped)="onDrop($event, TaskStatus.DONE)"
          id="done-list">
          @if (doneTasks().length === 0) {
            <p-message
              severity="info"
              text="No completed tasks"
              styleClass="empty-message">
            </p-message>
          } @else {
            @for (task of doneTasks(); track task.id) {
              <p-card
                styleClass="task-card"
                cdkDrag
                [cdkDragData]="task"
                (click)="openTaskDetails(task)">
                <ng-template pTemplate="header">
                  <div class="task-card-header">
                    @if (task.channel) {
                      <p-chip 
                        [label]="task.channel.name"
                        styleClass="channel-chip">
                      </p-chip>
                    }
                    @if (task.isRoutine) {
                      <i class="pi pi-refresh routine-icon" 
                         pTooltip="Routine Task"
                         tooltipPosition="top">
                      </i>
                    }
                  </div>
                </ng-template>

                <div class="task-card-body">
                  <h3 class="task-title">{{ task.title }}</h3>

                  @if (task.taskTags && task.taskTags.length > 0) {
                    <div class="task-tags">
                      @for (taskTag of task.taskTags; track taskTag.tag.id) {
                        <span
                          class="task-tag-chip"
                          [style.background-color]="taskTag.tag.color">
                          {{ taskTag.tag.name }}
                        </span>
                      }
                    </div>
                  }

                  <div class="task-meta">
                    <p-tag
                      [value]="task.workspace"
                      [severity]="getWorkspaceSeverity(task.workspace)"
                      styleClass="workspace-tag">
                    </p-tag>

                    @if (task.dueDate) {
                      <span class="due-date">
                        <i class="pi pi-calendar"></i>
                        {{ formatDate(task.dueDate) }}
                      </span>
                    }
                  </div>
                </div>
              </p-card>
            }
          }
        </div>
      </p-panel>
    </div>

  </div>
  }

  <!-- Focus Layout -->
  @if (currentLayout() === BoardLayout.FOCUS) {
  <div class="focus-board-layout">
    <!-- Focus Area - Top (IN_PROGRESS only) -->
    <div class="focus-area">
      <div class="column-header">
        <div class="column-title">
          <i class="pi pi-crosshair"></i>
          <span>Current Focus</span>
        </div>
        <p-badge [value]="inProgressTasks().length.toString()" severity="warn" />
      </div>

      <div
        class="column-content focus-content"
        cdkDropList
        [cdkDropListData]="inProgressTasks()"
        [cdkDropListConnectedTo]="['today-list', 'done-list']"
        (cdkDropListDropped)="onDrop($event, TaskStatus.IN_PROGRESS)"
        id="focus-list">
        @if (inProgressTasks().length === 0) {
          <div class="empty-state">
            <i class="pi pi-crosshair"></i>
            <p>No task in focus. Drag a task here to start working.</p>
          </div>
        } @else {
          @for (task of inProgressTasks(); track task.id) {
            <div
              class="task-card focus-task-card"
              cdkDrag
              [cdkDragData]="task">
              <div class="task-header">
                <h3>{{ task.title }}</h3>
              </div>

              @if (task.taskTags && task.taskTags.length > 0) {
                <div class="task-tags">
                  @for (taskTag of task.taskTags; track taskTag.tag.id) {
                    <span
                      class="task-tag-chip"
                      [style.background-color]="taskTag.tag.color">
                      {{ taskTag.tag.name }}
                    </span>
                  }
                </div>
              }

              @if (task.channel) {
                <div class="task-channel">
                  <span
                    class="channel-indicator"
                    [style.background-color]="task.channel.color"></span>
                  <span>{{ task.channel.name }}</span>
                </div>
              }
            </div>
          }
        }
      </div>
    </div>

    <!-- Bottom Columns - TODAY and DONE side-by-side -->
    <div class="bottom-columns">
      <!-- TODAY Column (minimized) -->
      <div class="kanban-column today-column">
        <div class="column-header">
          <div class="column-title">
            <i class="pi pi-calendar"></i>
            <span>Up Next</span>
          </div>
          <p-badge [value]="todayTasks().length.toString()" />
        </div>

        <!-- Progress Bar -->
        <div class="up-next-progress">
          <p-progressBar
            [value]="upNextProgress()"
            [showValue]="false"
            styleClass="up-next-progress-bar">
          </p-progressBar>
        </div>

        <!-- Quick Actions Row -->
        <div class="quick-actions-row">
          <p-button
            icon="pi pi-plus"
            label="Add task"
            (onClick)="showAddTaskDialog()"
            [text]="true"
            size="small"
            styleClass="add-task-quick-btn">
          </p-button>
          <p-button
            icon="pi pi-sort-alt"
            [label]="getSortLabel()"
            (onClick)="toggleSort()"
            [text]="true"
            size="small"
            styleClass="sort-toggle-btn">
          </p-button>
        </div>

        <div
          class="column-content"
          cdkDropList
          [cdkDropListData]="todayTasks()"
          [cdkDropListConnectedTo]="['focus-list', 'done-list']"
          (cdkDropListDropped)="onDrop($event, TaskStatus.TODAY)"
          id="today-list">
          @if (todayTasks().length === 0) {
            <div class="empty-state">
              <i class="pi pi-inbox"></i>
              <p>No tasks scheduled for today</p>
            </div>
          } @else {
            @for (task of todayTasks(); track task.id) {
              <div
                class="task-card compact-task-card"
                cdkDrag
                [cdkDragData]="task">
                <h4>{{ task.title }}</h4>

                @if (task.taskTags && task.taskTags.length > 0) {
                  <div class="task-tags">
                    @for (taskTag of task.taskTags; track taskTag.tag.id) {
                      <span
                        class="task-tag-chip"
                        [style.background-color]="taskTag.tag.color">
                        {{ taskTag.tag.name }}
                      </span>
                    }
                  </div>
                }
              </div>
            }
          }
        </div>
      </div>

      <!-- DONE Column (minimized) -->
      <div class="kanban-column done-column">
        <div class="column-header">
          <div class="column-title">
            <i class="pi pi-check-circle"></i>
            <span>Completed</span>
          </div>
          <p-badge [value]="doneTasks().length.toString()" severity="success" />
        </div>

        <div
          class="column-content"
          cdkDropList
          [cdkDropListData]="doneTasks()"
          [cdkDropListConnectedTo]="['today-list', 'focus-list']"
          (cdkDropListDropped)="onDrop($event, TaskStatus.DONE)"
          id="done-list">
          @if (doneTasks().length === 0) {
            <div class="empty-state">
              <i class="pi pi-check"></i>
              <p>No completed tasks</p>
            </div>
          } @else {
            @for (task of doneTasks(); track task.id) {
              <div
                class="task-card compact-task-card done-card"
                cdkDrag
                [cdkDragData]="task">
                <h4>{{ task.title }}</h4>

                @if (task.taskTags && task.taskTags.length > 0) {
                  <div class="task-tags">
                    @for (taskTag of task.taskTags; track taskTag.tag.id) {
                      <span
                        class="task-tag-chip"
                        [style.background-color]="taskTag.tag.color">
                        {{ taskTag.tag.name }}
                      </span>
                    }
                  </div>
                }
              </div>
            }
          }
        </div>
      </div>
    </div>
  </div>
  }

<!-- Task Details Dialog -->
@if (selectedTask()) {
  <p-dialog
    [(visible)]="showTaskDialog"
    [header]="selectedTask()?.title"
    [modal]="true"
    [closable]="true"
    [draggable]="false"
    [resizable]="false"
    styleClass="task-dialog"
    [style]="{ width: '600px', maxWidth: '90vw' }">

    <div class="task-details">
      <!-- Task Info -->
      <div class="detail-section">
        <h4>Details</h4>
        @if (selectedTask()?.description) {
          <p class="task-description">{{ selectedTask()?.description }}</p>
        } @else {
          <p class="no-description">No description provided</p>
        }
      </div>

      <!-- Metadata -->
      <div class="detail-section">
        <h4>Information</h4>
        <div class="metadata-grid">
          <div class="metadata-item">
            <span class="metadata-label">Workspace:</span>
            <p-tag
              [value]="selectedTask()?.workspace"
              [severity]="getWorkspaceSeverity(selectedTask()!.workspace)">
            </p-tag>
          </div>

          @if (selectedTask()?.channel) {
            <div class="metadata-item">
              <span class="metadata-label">Channel:</span>
              <p-chip [label]="selectedTask()!.channel!.name"></p-chip>
            </div>
          }

          <div class="metadata-item">
            <span class="metadata-label">Status:</span>
            <span class="status-badge">{{ selectedTask()?.status }}</span>
          </div>

          @if (selectedTask()?.dueDate) {
            <div class="metadata-item">
              <span class="metadata-label">Due Date:</span>
              <span>{{ formatDate(selectedTask()!.dueDate) }}</span>
            </div>
          }

          <div class="metadata-item">
            <span class="metadata-label">Routine:</span>
            <span>{{ selectedTask()?.isRoutine ? 'Yes' : 'No' }}</span>
          </div>
        </div>
      </div>

      <!-- Quick Status Changes -->
      <div class="detail-section">
        <h4>Move Task</h4>
        <div class="status-buttons">
          @if (selectedTask()?.status !== TaskStatus.TODAY) {
            <p-button
              label="Move to Today"
              icon="pi pi-calendar"
              severity="info"
              (onClick)="moveToStatus(selectedTask()!.id, TaskStatus.TODAY)">
            </p-button>
          }

          @if (selectedTask()?.status !== TaskStatus.IN_PROGRESS) {
            <p-button
              label="Move to In Progress"
              icon="pi pi-spinner"
              severity="warn"
              (onClick)="moveToStatus(selectedTask()!.id, TaskStatus.IN_PROGRESS)">
            </p-button>
          }

          @if (selectedTask()?.status !== TaskStatus.DONE) {
            <p-button
              label="Mark as Done"
              icon="pi pi-check-circle"
              severity="success"
              (onClick)="moveToStatus(selectedTask()!.id, TaskStatus.DONE)">
            </p-button>
          }
        </div>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <div class="dialog-footer">
        <p-button
          label="Delete"
          icon="pi pi-trash"
          severity="danger"
          [text]="true"
          (onClick)="deleteTask(selectedTask()!.id)">
        </p-button>
        <p-button
          label="Close"
          icon="pi pi-times"
          [text]="true"
          (onClick)="closeTaskDialog()">
        </p-button>
      </div>
    </ng-template>
  </p-dialog>
}

<!-- Create Task Dialog - Sleek Design -->
<p-dialog
  [(visible)]="createTaskDialogVisible"
  [modal]="true"
  [style]="{width: '700px'}"
  [draggable]="false"
  [resizable]="false"
  [showHeader]="false"
  [dismissableMask]="true"
  styleClass="sleek-task-dialog">
  <form [formGroup]="createTaskForm" (ngSubmit)="submitCreateTask()" class="sleek-form">
    <!-- Main Input -->
    <div class="task-input-container">
      <input
        id="title"
        type="text"
        formControlName="title"
        placeholder="Task description..."
        class="sleek-task-input"
        autocomplete="off"
      />
    </div>

    <!-- Metadata Row -->
    <div class="metadata-row">
      <!-- Status Button -->
      <button type="button" class="metadata-btn" (click)="op1.toggle($event)">
        <i class="pi pi-calendar"></i>
        <span>{{ createTaskForm.get('status')?.value === 'TODAY' ? 'Today' : 'Backlog' }}</span>
      </button>
      <p-popover #op1>
        <div class="metadata-popover">
          @for (option of statusOptions; track option.value) {
            <div class="popover-option" (click)="createTaskForm.patchValue({status: option.value}); op1.hide()">
              <i class="pi pi-calendar"></i>
              <span>{{ option.label }}</span>
            </div>
          }
        </div>
      </p-popover>

      <!-- Channel Button -->
      <button type="button" class="metadata-btn" (click)="op2.toggle($event)">
        <i class="pi pi-hashtag"></i>
        <span>{{ getChannelName(createTaskForm.get('channelId')?.value) || 'No channel' }}</span>
      </button>
      <p-popover #op2>
        <div class="metadata-popover">
          @for (channel of filteredChannels(); track channel.id) {
            <div class="popover-option" (click)="createTaskForm.patchValue({channelId: channel.id}); op2.hide()">
              <i class="pi pi-hashtag"></i>
              <span>{{ channel.name }}</span>
            </div>
          }
        </div>
      </p-popover>

      <!-- Workspace Button -->
      <button type="button" class="metadata-btn" (click)="op3.toggle($event)">
        <i class="pi pi-{{ createTaskForm.get('workspace')?.value === 'WORK' ? 'briefcase' : 'home' }}"></i>
      </button>
      <p-popover #op3>
        <div class="metadata-popover">
          @for (workspace of workspaceOptions; track workspace.value) {
            <div class="popover-option" (click)="createTaskForm.patchValue({workspace: workspace.value}); op3.hide()">
              <i class="pi pi-{{ workspace.value === 'WORK' ? 'briefcase' : 'home' }}"></i>
              <span>{{ workspace.label }}</span>
            </div>
          }
        </div>
      </p-popover>
    </div>

    <!-- Bottom Actions -->
    <div class="dialog-bottom-actions">
      <button type="button" class="cancel-btn" (click)="hideCreateTaskDialog()">
        <span>Cancel</span>
      </button>
      <button type="button" class="add-task-btn" (click)="submitCreateTask()" [disabled]="createTaskForm.invalid">
        <i class="pi pi-user-plus"></i>
        <span>Add task</span>
      </button>
    </div>
  </form>
</p-dialog>
