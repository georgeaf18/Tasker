<div class="kanban-container">
  <!-- Progress Bar at Top -->
  <div class="progress-section">
    <div class="progress-header">
      <h2>Daily Progress</h2>
      <span class="progress-percentage">{{ dailyProgress() }}%</span>
    </div>
    <p-progressBar 
      [value]="dailyProgress()" 
      [showValue]="false"
      styleClass="custom-progress-bar">
    </p-progressBar>
  </div>

  <!-- Three-Column Kanban Board -->
  <div class="kanban-board">
    
    <!-- TODAY Column -->
    <div class="kanban-column today-column">
      <p-panel styleClass="kanban-panel">
        <ng-template pTemplate="header">
          <div class="column-header">
            <div class="column-title">
              <i class="pi pi-calendar"></i>
              <span>Today</span>
            </div>
            <p-badge 
              [value]="todayTasks().length.toString()" 
              severity="info">
            </p-badge>
          </div>
        </ng-template>

        <div class="column-content">
          @if (todayTasks().length === 0) {
            <p-message 
              severity="info" 
              text="No tasks scheduled for today"
              styleClass="empty-message">
            </p-message>
          } @else {
            @for (task of todayTasks(); track task.id) {
              <p-card 
                styleClass="task-card"
                (click)="openTaskDetails(task)">
                <ng-template pTemplate="header">
                  <div class="task-card-header">
                    @if (task.channel) {
                      <p-chip 
                        [label]="task.channel.name"
                        styleClass="channel-chip">
                      </p-chip>
                    }
                    @if (task.isRoutine) {
                      <i class="pi pi-refresh routine-icon" 
                         pTooltip="Routine Task"
                         tooltipPosition="top">
                      </i>
                    }
                  </div>
                </ng-template>

                <div class="task-card-body">
                  <h3 class="task-title">{{ task.title }}</h3>
                  
                  <div class="task-meta">
                    <p-tag 
                      [value]="task.workspace"
                      [severity]="getWorkspaceSeverity(task.workspace)"
                      styleClass="workspace-tag">
                    </p-tag>
                    
                    @if (task.dueDate) {
                      <span class="due-date">
                        <i class="pi pi-calendar"></i>
                        {{ formatDate(task.dueDate) }}
                      </span>
                    }
                  </div>
                </div>
              </p-card>
            }
          }
        </div>
      </p-panel>
    </div>

    <!-- IN PROGRESS Column -->
    <div class="kanban-column in-progress-column">
      <p-panel styleClass="kanban-panel">
        <ng-template pTemplate="header">
          <div class="column-header">
            <div class="column-title">
              <i class="pi pi-spinner"></i>
              <span>In Progress</span>
            </div>
            <p-badge
              [value]="inProgressTasks().length.toString()"
              severity="warn">
            </p-badge>
          </div>
        </ng-template>

        <div class="column-content">
          @if (inProgressTasks().length === 0) {
            <p-message 
              severity="info" 
              text="No tasks in progress"
              styleClass="empty-message">
            </p-message>
          } @else {
            @for (task of inProgressTasks(); track task.id) {
              <p-card 
                styleClass="task-card"
                (click)="openTaskDetails(task)">
                <ng-template pTemplate="header">
                  <div class="task-card-header">
                    @if (task.channel) {
                      <p-chip 
                        [label]="task.channel.name"
                        styleClass="channel-chip">
                      </p-chip>
                    }
                    @if (task.isRoutine) {
                      <i class="pi pi-refresh routine-icon" 
                         pTooltip="Routine Task"
                         tooltipPosition="top">
                      </i>
                    }
                  </div>
                </ng-template>

                <div class="task-card-body">
                  <h3 class="task-title">{{ task.title }}</h3>
                  
                  <div class="task-meta">
                    <p-tag 
                      [value]="task.workspace"
                      [severity]="getWorkspaceSeverity(task.workspace)"
                      styleClass="workspace-tag">
                    </p-tag>
                    
                    @if (task.dueDate) {
                      <span class="due-date">
                        <i class="pi pi-calendar"></i>
                        {{ formatDate(task.dueDate) }}
                      </span>
                    }
                  </div>
                </div>
              </p-card>
            }
          }
        </div>
      </p-panel>
    </div>

    <!-- DONE Column -->
    <div class="kanban-column done-column">
      <p-panel styleClass="kanban-panel">
        <ng-template pTemplate="header">
          <div class="column-header">
            <div class="column-title">
              <i class="pi pi-check-circle"></i>
              <span>Done</span>
            </div>
            <p-badge 
              [value]="doneTasks().length.toString()" 
              severity="success">
            </p-badge>
          </div>
        </ng-template>

        <div class="column-content">
          @if (doneTasks().length === 0) {
            <p-message 
              severity="info" 
              text="No completed tasks"
              styleClass="empty-message">
            </p-message>
          } @else {
            @for (task of doneTasks(); track task.id) {
              <p-card 
                styleClass="task-card"
                (click)="openTaskDetails(task)">
                <ng-template pTemplate="header">
                  <div class="task-card-header">
                    @if (task.channel) {
                      <p-chip 
                        [label]="task.channel.name"
                        styleClass="channel-chip">
                      </p-chip>
                    }
                    @if (task.isRoutine) {
                      <i class="pi pi-refresh routine-icon" 
                         pTooltip="Routine Task"
                         tooltipPosition="top">
                      </i>
                    }
                  </div>
                </ng-template>

                <div class="task-card-body">
                  <h3 class="task-title">{{ task.title }}</h3>
                  
                  <div class="task-meta">
                    <p-tag 
                      [value]="task.workspace"
                      [severity]="getWorkspaceSeverity(task.workspace)"
                      styleClass="workspace-tag">
                    </p-tag>
                    
                    @if (task.dueDate) {
                      <span class="due-date">
                        <i class="pi pi-calendar"></i>
                        {{ formatDate(task.dueDate) }}
                      </span>
                    }
                  </div>
                </div>
              </p-card>
            }
          }
        </div>
      </p-panel>
    </div>

  </div>
</div>

<!-- Task Details Dialog -->
@if (selectedTask()) {
  <p-dialog 
    [(visible)]="showTaskDialog"
    [header]="selectedTask()?.title"
    [modal]="true"
    [closable]="true"
    [draggable]="false"
    [resizable]="false"
    styleClass="task-dialog"
    [style]="{ width: '600px', maxWidth: '90vw' }">
    
    <div class="task-details">
      <!-- Task Info -->
      <div class="detail-section">
        <h4>Details</h4>
        @if (selectedTask()?.description) {
          <p class="task-description">{{ selectedTask()?.description }}</p>
        } @else {
          <p class="no-description">No description provided</p>
        }
      </div>

      <!-- Metadata -->
      <div class="detail-section">
        <h4>Information</h4>
        <div class="metadata-grid">
          <div class="metadata-item">
            <span class="metadata-label">Workspace:</span>
            <p-tag 
              [value]="selectedTask()?.workspace"
              [severity]="getWorkspaceSeverity(selectedTask()!.workspace)">
            </p-tag>
          </div>

          @if (selectedTask()?.channel) {
            <div class="metadata-item">
              <span class="metadata-label">Channel:</span>
              <p-chip [label]="selectedTask()!.channel!.name"></p-chip>
            </div>
          }

          <div class="metadata-item">
            <span class="metadata-label">Status:</span>
            <span class="status-badge">{{ selectedTask()?.status }}</span>
          </div>

          @if (selectedTask()?.dueDate) {
            <div class="metadata-item">
              <span class="metadata-label">Due Date:</span>
              <span>{{ formatDate(selectedTask()!.dueDate) }}</span>
            </div>
          }

          <div class="metadata-item">
            <span class="metadata-label">Routine:</span>
            <span>{{ selectedTask()?.isRoutine ? 'Yes' : 'No' }}</span>
          </div>
        </div>
      </div>

      <!-- Quick Status Changes -->
      <div class="detail-section">
        <h4>Move Task</h4>
        <div class="status-buttons">
          @if (selectedTask()?.status !== TaskStatus.TODAY) {
            <p-button 
              label="Move to Today"
              icon="pi pi-calendar"
              severity="info"
              (onClick)="moveToStatus(selectedTask()!.id, TaskStatus.TODAY)">
            </p-button>
          }

          @if (selectedTask()?.status !== TaskStatus.IN_PROGRESS) {
            <p-button
              label="Move to In Progress"
              icon="pi pi-spinner"
              severity="warn"
              (onClick)="moveToStatus(selectedTask()!.id, TaskStatus.IN_PROGRESS)">
            </p-button>
          }

          @if (selectedTask()?.status !== TaskStatus.DONE) {
            <p-button 
              label="Mark as Done"
              icon="pi pi-check-circle"
              severity="success"
              (onClick)="moveToStatus(selectedTask()!.id, TaskStatus.DONE)">
            </p-button>
          }
        </div>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <div class="dialog-footer">
        <p-button 
          label="Delete"
          icon="pi pi-trash"
          severity="danger"
          [text]="true"
          (onClick)="deleteTask(selectedTask()!.id)">
        </p-button>
        <p-button 
          label="Close"
          icon="pi pi-times"
          [text]="true"
          (onClick)="closeTaskDialog()">
        </p-button>
      </div>
    </ng-template>
  </p-dialog>
}
