#!/usr/bin/env sh

# Get the current branch name
current_branch=$(git symbolic-ref --short HEAD 2>/dev/null)

# Check if pushing to main or develop
if [ "$current_branch" = "main" ] || [ "$current_branch" = "develop" ]; then
  echo ""
  echo "âŒ ERROR: Direct pushes to '$current_branch' branch are not allowed!"
  echo ""
  echo "ğŸ“‹ Required workflow:"
  echo "  1. Create a feature branch: git checkout -b feature/TASK-xxx-description"
  echo "  2. Make your changes and commit"
  echo "  3. Push the feature branch: git push origin feature/TASK-xxx-description"
  echo "  4. Create a Pull Request to merge into $current_branch"
  echo ""
  echo "ğŸ’¡ To push this branch anyway (for emergencies only):"
  echo "   git push --no-verify"
  echo ""
  exit 1
fi

echo ""
echo "ğŸ§ª Running tests before push..."
echo ""

# Run unit tests on affected projects
echo "ğŸ“ Running unit tests on affected code..."
npx nx affected -t test --parallel=3 --exclude='*-e2e'

if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ Unit tests failed! Please fix the tests before pushing."
  echo ""
  exit 1
fi

# TODO(TASK-999): Re-enable e2e tests once Playwright infrastructure is fixed
# Check if any source code was affected (not just docs/config)
# affected_source=$(git diff --name-only origin/main...HEAD | grep -E '\.(ts|tsx|js|jsx|html|css|scss)$' | grep -v -E '^docs/|\.spec\.|\.test\.|\.config\.' || true)
#
# # Only run e2e tests if source code was changed
# if [ -n "$affected_source" ]; then
#   echo ""
#   echo "ğŸ¯ Running critical e2e tests..."
#   npx nx run-many -t e2e:critical --parallel=1
#
#   if [ $? -ne 0 ]; then
#     echo ""
#     echo "âŒ Critical e2e tests failed! Please fix the tests before pushing."
#     echo "ğŸ’¡ To push anyway (not recommended): git push --no-verify"
#     echo ""
#     exit 1
#   fi
# else
#   echo ""
#   echo "â­ï¸  Skipping e2e tests (no source code changes detected)"
# fi

echo ""
echo "â­ï¸  E2E tests temporarily disabled (Playwright infrastructure needs configuration)"

echo ""
echo "âœ… All tests passed!"
echo ""

exit 0
